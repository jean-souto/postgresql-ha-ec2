# Secrets Management

> **[English](#english)** | **[Português](#portugues)**

---

<a name="english"></a>
## English

This project uses **AWS SSM Parameter Store** for secrets management instead of AWS Secrets Manager.

### Why SSM Parameter Store?

| Aspect | SSM Parameter Store | Secrets Manager |
|--------|---------------------|-----------------|
| **Cost** | Free (standard tier) | $0.40/secret/month |
| **Encryption** | AWS managed keys (free) | AWS managed keys (free) |
| **Rotation** | Manual | Automatic (with Lambda) |
| **Best for** | Static secrets, cost-sensitive | Dynamic secrets, auto-rotation |

For a demo/lab environment, SSM Parameter Store provides adequate security at zero cost.

---

## Secrets Architecture

```
SSM Parameter Store
└── /pgha/
    ├── postgres-password      # PostgreSQL superuser password
    ├── replication-password   # Streaming replication password
    ├── pgbouncer-password     # PgBouncer authentication
    └── patroni-api-password   # Patroni REST API authentication
```

### Secret Inventory

| Parameter Path | Used By | Purpose |
|----------------|---------|---------|
| `/pgha/postgres-password` | PostgreSQL, Applications | Superuser authentication |
| `/pgha/replication-password` | Patroni, PostgreSQL | Streaming replication between nodes |
| `/pgha/pgbouncer-password` | PgBouncer | Connection pooler authentication |
| `/pgha/patroni-api-password` | Patroni, NLB | REST API authentication for health checks |

---

## Terraform Configuration

Secrets are created in `terraform/ssm.tf`:

```hcl
resource "random_password" "postgres" {
  length           = 24
  special          = true
  override_special = "!#$%&*()-_=+[]{}|"
}

resource "aws_ssm_parameter" "postgres_password" {
  name        = "/pgha/postgres-password"
  description = "PostgreSQL superuser password"
  type        = "SecureString"
  value       = random_password.postgres.result

  tags = local.common_tags
}
```

Key points:
- **SecureString type**: Encrypted with AWS managed key (`aws/ssm`)
- **Random generation**: Passwords generated by Terraform, not hardcoded
- **No tfvars exposure**: Secrets never appear in `.tfvars` files

---

## IAM Permissions

### EC2 Instance Role

Patroni and etcd instances have an IAM role that allows reading secrets:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameter",
        "ssm:GetParameters"
      ],
      "Resource": "arn:aws:ssm:us-east-1:*:parameter/pgha/*"
    }
  ]
}
```

This follows **least privilege**: instances can only read `/pgha/*` parameters.

---

## Reading Secrets

### From AWS CLI

```bash
# Single secret
aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --profile postgresql-ha-profile \
  --query 'Parameter.Value' \
  --output text

# Multiple secrets
aws ssm get-parameters \
  --names "/pgha/postgres-password" "/pgha/replication-password" \
  --with-decryption \
  --profile postgresql-ha-profile
```

### From EC2 Instance (User Data)

```bash
#!/bin/bash
# In user-data scripts, instance role provides authentication

POSTGRES_PASSWORD=$(aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --region us-east-1 \
  --query 'Parameter.Value' \
  --output text)

export PGPASSWORD="$POSTGRES_PASSWORD"
```

---

## Password Rotation

### Manual Rotation Procedure

1. **Generate new password:**
   ```bash
   NEW_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9!#$%&*()-_=+[]{}|' | head -c 24)
   ```

2. **Update in SSM:**
   ```bash
   aws ssm put-parameter \
     --name "/pgha/postgres-password" \
     --value "$NEW_PASSWORD" \
     --type "SecureString" \
     --overwrite \
     --profile postgresql-ha-profile
   ```

3. **Update in PostgreSQL:**
   ```sql
   ALTER USER postgres WITH PASSWORD 'new_password_here';
   ```

4. **Restart services:**
   ```bash
   sudo systemctl restart patroni
   ```

### Rotation Best Practices

- **Rotate regularly**: Every 90 days for production
- **Rotate after incidents**: If credentials may have been exposed
- **Test after rotation**: Verify applications can still connect

---

## Security Considerations

### What SSM Parameter Store Provides

- **Encryption at rest**: AES-256 with AWS managed keys
- **Encryption in transit**: TLS for API calls
- **Access control**: IAM policies control who can read/write
- **Audit trail**: CloudTrail logs all parameter access

### What It Does NOT Provide

- **Automatic rotation**: Must rotate manually
- **Secret versioning**: Only current value stored
- **Cross-region replication**: Parameters are regional

### Recommendations

1. **Never hardcode secrets** in code or configuration files
2. **Use IAM roles** instead of access keys on EC2 instances
3. **Restrict access** with specific IAM policies
4. **Monitor access** via CloudTrail logs
5. **Rotate regularly** based on security policy

---

## Troubleshooting

### Cannot Read Parameter

**Error:** `AccessDeniedException`

**Check:**
1. IAM role attached to instance
2. IAM policy allows `ssm:GetParameter`
3. Resource ARN matches parameter path

```bash
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

### Parameter Not Found

**Error:** `ParameterNotFound`

**Check:**
1. Parameter exists:
   ```bash
   aws ssm describe-parameters \
     --filters "Key=Name,Values=/pgha/" \
     --profile postgresql-ha-profile
   ```
2. Region is correct (parameters are regional)

---

<a name="portugues"></a>
## Português

Este projeto usa **AWS SSM Parameter Store** para gestão de secrets ao invés do AWS Secrets Manager.

### Por que SSM Parameter Store?

| Aspecto | SSM Parameter Store | Secrets Manager |
|---------|---------------------|-----------------|
| **Custo** | Gratuito (tier standard) | $0.40/secret/mês |
| **Criptografia** | Chaves AWS gerenciadas (grátis) | Chaves AWS gerenciadas (grátis) |
| **Rotação** | Manual | Automática (com Lambda) |
| **Melhor para** | Secrets estáticos, sensível a custo | Secrets dinâmicos, auto-rotação |

Para ambiente demo/lab, SSM Parameter Store fornece segurança adequada a custo zero.

---

## Arquitetura de Secrets

```
SSM Parameter Store
└── /pgha/
    ├── postgres-password      # Senha do superuser PostgreSQL
    ├── replication-password   # Senha de replicação streaming
    ├── pgbouncer-password     # Autenticação PgBouncer
    └── patroni-api-password   # Autenticação API REST Patroni
```

### Inventário de Secrets

| Caminho do Parâmetro | Usado Por | Propósito |
|----------------------|-----------|-----------|
| `/pgha/postgres-password` | PostgreSQL, Aplicações | Autenticação superuser |
| `/pgha/replication-password` | Patroni, PostgreSQL | Replicação streaming entre nós |
| `/pgha/pgbouncer-password` | PgBouncer | Autenticação do connection pooler |
| `/pgha/patroni-api-password` | Patroni, NLB | Autenticação API REST para health checks |

---

## Configuração Terraform

Secrets são criados em `terraform/ssm.tf`:

```hcl
resource "random_password" "postgres" {
  length           = 24
  special          = true
  override_special = "!#$%&*()-_=+[]{}|"
}

resource "aws_ssm_parameter" "postgres_password" {
  name        = "/pgha/postgres-password"
  description = "PostgreSQL superuser password"
  type        = "SecureString"
  value       = random_password.postgres.result

  tags = local.common_tags
}
```

Pontos-chave:
- **Tipo SecureString**: Criptografado com chave AWS gerenciada (`aws/ssm`)
- **Geração aleatória**: Senhas geradas pelo Terraform, não hardcoded
- **Sem exposição tfvars**: Secrets nunca aparecem em arquivos `.tfvars`

---

## Permissões IAM

### Role da Instância EC2

Instâncias Patroni e etcd têm uma role IAM que permite ler secrets:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameter",
        "ssm:GetParameters"
      ],
      "Resource": "arn:aws:ssm:us-east-1:*:parameter/pgha/*"
    }
  ]
}
```

Isto segue **privilégio mínimo**: instâncias só podem ler parâmetros `/pgha/*`.

---

## Lendo Secrets

### Do AWS CLI

```bash
# Secret único
aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --profile postgresql-ha-profile \
  --query 'Parameter.Value' \
  --output text

# Múltiplos secrets
aws ssm get-parameters \
  --names "/pgha/postgres-password" "/pgha/replication-password" \
  --with-decryption \
  --profile postgresql-ha-profile
```

### Da Instância EC2 (User Data)

```bash
#!/bin/bash
# Em scripts user-data, role da instância fornece autenticação

POSTGRES_PASSWORD=$(aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --region us-east-1 \
  --query 'Parameter.Value' \
  --output text)

export PGPASSWORD="$POSTGRES_PASSWORD"
```

---

## Rotação de Senha

### Procedimento de Rotação Manual

1. **Gere nova senha:**
   ```bash
   NEW_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9!#$%&*()-_=+[]{}|' | head -c 24)
   ```

2. **Atualize no SSM:**
   ```bash
   aws ssm put-parameter \
     --name "/pgha/postgres-password" \
     --value "$NEW_PASSWORD" \
     --type "SecureString" \
     --overwrite \
     --profile postgresql-ha-profile
   ```

3. **Atualize no PostgreSQL:**
   ```sql
   ALTER USER postgres WITH PASSWORD 'nova_senha_aqui';
   ```

4. **Reinicie serviços:**
   ```bash
   sudo systemctl restart patroni
   ```

### Boas Práticas de Rotação

- **Rotacione regularmente**: A cada 90 dias para produção
- **Rotacione após incidentes**: Se credenciais podem ter sido expostas
- **Teste após rotação**: Verifique se aplicações ainda conseguem conectar

---

## Considerações de Segurança

### O que SSM Parameter Store Fornece

- **Criptografia em repouso**: AES-256 com chaves AWS gerenciadas
- **Criptografia em trânsito**: TLS para chamadas API
- **Controle de acesso**: Políticas IAM controlam quem pode ler/escrever
- **Trilha de auditoria**: CloudTrail registra todo acesso a parâmetros

### O que NÃO Fornece

- **Rotação automática**: Deve rotacionar manualmente
- **Versionamento de secrets**: Apenas valor atual armazenado
- **Replicação cross-region**: Parâmetros são regionais

### Recomendações

1. **Nunca hardcode secrets** em código ou arquivos de configuração
2. **Use roles IAM** ao invés de access keys em instâncias EC2
3. **Restrinja acesso** com políticas IAM específicas
4. **Monitore acesso** via logs CloudTrail
5. **Rotacione regularmente** baseado em política de segurança

---

## Solução de Problemas

### Não Consegue Ler Parâmetro

**Erro:** `AccessDeniedException`

**Verifique:**
1. Role IAM anexada à instância
2. Política IAM permite `ssm:GetParameter`
3. ARN do recurso corresponde ao caminho do parâmetro

```bash
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

### Parâmetro Não Encontrado

**Erro:** `ParameterNotFound`

**Verifique:**
1. Parâmetro existe:
   ```bash
   aws ssm describe-parameters \
     --filters "Key=Name,Values=/pgha/" \
     --profile postgresql-ha-profile
   ```
2. Região está correta (parâmetros são regionais)
